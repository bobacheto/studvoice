// Prisma Schema for StudVoice
// Anonymous student platform with secure authentication

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==========================================
// ENUMS
// ==========================================

enum Role {
  STUDENT
  MODERATOR
  STUDENT_COUNCIL
  TEACHER
  DIRECTOR
  ADMIN
}

enum IdeaStatus {
  PENDING
  UNDER_REVIEW
  ACCEPTED
  COMPLETED
  REJECTED
}

enum ReactionType {
  LIKE
  SUPPORT
  GREAT
  THINKING
}

enum ReportStatus {
  OPEN
  REVIEWED
  RESOLVED
}

enum ReportTargetType {
  POST
  COMMENT
}

enum StrikeType {
  MUTE
  WARNING
  BAN
}

enum AMAQuestionStatus {
  PENDING
  ANSWERED
  REJECTED
}

enum ChallengeType {
  GRATITUDE
  IDEA_SPRINT
  PROBLEM_SOLVER
  CUSTOM
}

// ==========================================
// CORE MODELS (AUTH)
// ==========================================

// School entity - represents a school using StudVoice
model School {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique // Unique school code for registration
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users      User[]
  posts      Post[]
  polls      Poll[]
  amas       AMA[]
  challenges Challenge[]

  @@index([code])
}

// User entity - student account
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String   // bcrypt hashed password
  anonymousId   String   @unique // For anonymous posts/comments
  role          Role     @default(STUDENT)
  schoolId      String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  isActive      Boolean  @default(true)

  // Relations
  school              School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  refreshTokens       RefreshToken[]
  createdAMAs         AMA[]
  amaAnswers          AMAAnswer[]
  createdChallenges   Challenge[]
  ideaStatusChanges   IdeaStatusHistory[]
  moderationActions   ModerationAction[]

  @@index([email])
  @@index([schoolId])
  @@index([anonymousId])
}

// RefreshToken entity - for JWT refresh token management
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ==========================================
// POSTS & COMMENTS
// ==========================================

// Post entity - anonymous student ideas/problems
model Post {
  id          String      @id @default(cuid())
  anonymousId String      // Not userId - maintain anonymity
  title       String?
  content     String
  status      IdeaStatus  @default(PENDING)
  schoolId    String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  school            School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  comments          Comment[]
  reactions         Reaction[]
  reports           Report[]
  statusHistory     IdeaStatusHistory[]

  @@index([anonymousId])
  @@index([schoolId])
  @@index([status])
  @@index([createdAt])
}

// Comment entity - anonymous responses to posts
model Comment {
  id          String   @id @default(cuid())
  postId      String
  anonymousId String   // Not userId - maintain anonymity
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  reports     Report[]

  @@index([postId])
  @@index([anonymousId])
  @@index([createdAt])
}

// Reaction entity - positive reactions on posts
model Reaction {
  id          String       @id @default(cuid())
  postId      String
  anonymousId String       // Not userId - maintain anonymity
  type        ReactionType
  createdAt   DateTime     @default(now())

  // Relations
  post        Post         @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, anonymousId, type])
  @@index([postId])
  @@index([anonymousId])
}

// ==========================================
// MODERATION
// ==========================================

// Report entity - for reporting posts or comments
model Report {
  id             String           @id @default(cuid())
  postId         String?
  commentId      String?
  anonymousId    String           // Reporter's anonymousId
  targetType     ReportTargetType
  reason         String
  status         ReportStatus     @default(OPEN)
  createdAt      DateTime         @default(now())
  reviewedAt     DateTime?

  // Relations
  post           Post?            @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment        Comment?         @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([commentId])
  @@index([status])
  @@index([createdAt])
}

// Strike entity - tracks mutes, warnings, and bans
model Strike {
  id             String     @id @default(cuid())
  anonymousId    String     // Target user's anonymousId
  type           StrikeType
  reason         String?
  durationHours  Int?       // For mutes - how long the mute lasts
  createdAt      DateTime   @default(now())
  expiresAt      DateTime?  // Calculated from durationHours

  @@index([anonymousId])
  @@index([type])
  @@index([expiresAt])
}

// ModerationAction entity - logs all moderation decisions
model ModerationAction {
  id                 String   @id @default(cuid())
  moderatorId        String   // User performing the action
  targetAnonymousId  String   // Target user's anonymousId
  action             String   // Description of action taken
  reason             String?
  createdAt          DateTime @default(now())

  // Relations
  moderator          User     @relation(fields: [moderatorId], references: [id], onDelete: Cascade)

  @@index([moderatorId])
  @@index([targetAnonymousId])
  @@index([createdAt])
}

// ==========================================
// POLLS
// ==========================================

// Poll entity - created by STUDENT_COUNCIL
model Poll {
  id                 String       @id @default(cuid())
  title              String
  description        String?
  schoolId           String
  createdByAnonymousId String     // Creator's anonymousId
  createdAt          DateTime     @default(now())
  expiresAt          DateTime?
  updatedAt          DateTime     @updatedAt

  // Relations
  school             School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  options            PollOption[]
  votes              PollVote[]

  @@index([schoolId])
  @@index([createdByAnonymousId])
  @@index([expiresAt])
}

// PollOption entity - individual poll choices
model PollOption {
  id        String     @id @default(cuid())
  pollId    String
  text      String
  createdAt DateTime   @default(now())

  // Relations
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes     PollVote[]

  @@index([pollId])
}

// PollVote entity - anonymous votes on polls
model PollVote {
  id             String     @id @default(cuid())
  pollId         String
  pollOptionId   String
  anonymousId    String     // Not userId - maintain anonymity
  createdAt      DateTime   @default(now())

  // Relations
  poll           Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  pollOption     PollOption @relation(fields: [pollOptionId], references: [id], onDelete: Cascade)

  @@unique([pollId, anonymousId])
  @@index([pollId])
  @@index([pollOptionId])
  @@index([anonymousId])
}

// ==========================================
// AMA (ASK ME ANYTHING)
// ==========================================

// AMA entity - Ask Me Anything sessions
model AMA {
  id             String        @id @default(cuid())
  title          String
  description    String?
  schoolId       String
  createdByUserId String       // Teacher or Student Council member
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdBy      User          @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  questions      AMAQuestion[]

  @@index([schoolId])
  @@index([createdByUserId])
  @@index([isActive])
}

// AMAQuestion entity - anonymous questions in AMA sessions
model AMAQuestion {
  id          String             @id @default(cuid())
  amaId       String
  anonymousId String             // Not userId - maintain anonymity
  content     String
  status      AMAQuestionStatus  @default(PENDING)
  createdAt   DateTime           @default(now())

  // Relations
  ama         AMA                @relation(fields: [amaId], references: [id], onDelete: Cascade)
  answer      AMAAnswer?

  @@index([amaId])
  @@index([anonymousId])
  @@index([status])
}

// AMAAnswer entity - answers to AMA questions
model AMAAnswer {
  id                String      @id @default(cuid())
  questionId        String      @unique
  answeredByUserId  String      // Teacher or Student Council member
  content           String
  createdAt         DateTime    @default(now())

  // Relations
  question          AMAQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answeredBy        User        @relation(fields: [answeredByUserId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@index([answeredByUserId])
}

// ==========================================
// CHALLENGES
// ==========================================

// Challenge entity - gamification challenges
model Challenge {
  id              String                @id @default(cuid())
  title           String
  description     String
  type            ChallengeType
  schoolId        String
  createdByUserId String
  startAt         DateTime
  endAt           DateTime
  isActive        Boolean               @default(true)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Relations
  school          School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdBy       User                  @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  submissions     ChallengeSubmission[]

  @@index([schoolId])
  @@index([createdByUserId])
  @@index([type])
  @@index([isActive])
  @@index([startAt])
  @@index([endAt])
}

// ChallengeSubmission entity - student submissions for challenges
model ChallengeSubmission {
  id          String    @id @default(cuid())
  challengeId String
  anonymousId String    // Not userId - maintain anonymity
  content     String
  createdAt   DateTime  @default(now())

  // Relations
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@index([challengeId])
  @@index([anonymousId])
  @@index([createdAt])
}

// ==========================================
// IDEA STATUS TRACKING
// ==========================================

// IdeaStatusHistory entity - tracks status changes for posts
model IdeaStatusHistory {
  id              String     @id @default(cuid())
  postId          String
  fromStatus      IdeaStatus
  toStatus        IdeaStatus
  changedByUserId String
  createdAt       DateTime   @default(now())

  // Relations
  post            Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  changedBy       User       @relation(fields: [changedByUserId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([changedByUserId])
  @@index([createdAt])
}
